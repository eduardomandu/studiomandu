  <!DOCTYPE html>
  <html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Studio Mandú - System</title>

    <!-- libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- visual (separate) -->
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <header class="site-header">
      <button id="openPricing" class="btn-floating">Precificação</button>

      <div id="logoArea" class="logo-area">
        <img src="logo.png" alt="Logo Studio Mandú" class="logo-img" />
      </div>

      <h1 class="site-title">Studio Mandú — Estética Profissional</h1>
    </header>

    <main class="container">
      <div class="left-col">
        <section class="card">
          <h3>Cadastro de Produtos</h3>
          <label>Nome do produto</label>
          <input id="produtoNome" placeholder="Ex: Canelinha Finisher">
          <div class="row">
            <div class="col">
              <label>Preço (R$)</label>
              <input id="produtoPreco" type="number" step="0.01" placeholder="Ex: 39.90">
            </div>
            <div class="col">
              <label>Qtd. (ml)</label>
              <input id="produtoML" type="number" placeholder="Ex: 500">
            </div>
          </div>

          <div class="row gap10">
            <button onclick="addProduto()" class="btn" style="margin-top: 13px;">Adicionar produto</button>
            <button class="btn ghost" onclick="importDemo()" style="margin-top: 13px;">Importar produtos</button>
          </div>

          <div id="produtosList" class="list-area"></div>
        </section>

        <section class="card" style="margin-top:14px;">
          <div class="section-header">
            <h3>Checklist Deluxe</h3>
            <div class="section-actions">
              <button class="ghost small" onclick="limparChecklist()" style="margin-bottom: 10px" style="margin: 10px;">Limpar checklist</button>
            </div>
          </div>
          <div class="check-grid" id="checklistGrid"></div>
          <p class="muted small mt8">Marque cada item durante o serviço — será incluído no PDF final.</p>
        </section>
      </div>

      <div class="right-col">
        <section class="card">
          <h3>Uso no Serviço</h3>
          <label>Selecione produto</label>
          <select id="listaProdutos"></select>

          <label>Quantidade usada (ml)</label>
          <input id="qtdUsada" type="number" placeholder="Ex: 20">

          <div class="row gap10" style="margin-top:10px;">
            <button onclick="addUso()" class="btn">Adicionar ao cálculo</button>
            <button class="btn ghost" onclick="clearUsos()">Limpar usos</button>
          </div>

          <h4 class="mt12">Produtos usados</h4>
          <div id="listaUsos" class="list-area"></div>

          <label>Serviço selecionado (precificação)</label>
          <select id="selectService"><option value="-1">Nenhum serviço configurado</option></select>

          <h3 class="mt14">Total gasto em produtos: R$ <span id="totalGasto">0.00</span></h3>

          <div class="row gap8 mt12">
            <button onclick="gerarPDF()" class="btn">Gerar relatório PDF</button>
            <button class="btn ghost" onclick="exportarJSON()">Exportar (.json)</button>
          </div>

          <p class="muted mt8">Produtos salvos no navegador (localStorage).</p>
        </section>

        <section class="card mt16">
          <h3>Configurações</h3>
          <label>Nome da estética</label>
          <input id="nomeEstetica" placeholder="Ex: Meu Detail Pro">
          <label>Nome do cliente / moto</label>
          <input id="nomeCliente" placeholder="Ex: João - Honda CG 160">
          <label>Observações</label>
          <textarea id="obs" rows="3" placeholder="Observações do serviço..."></textarea>

          <div class="row gap8 mt10">
            <button onclick="salvarConfig()" class="btn">Salvar configuração</button>
            <button class="btn ghost" onclick="carregarConfig()">Carregar configur.</button>
          </div>
        </section>
      </div>

      <div class="full-col">
        <section class="card">
          <h3>Como usar / Persistência</h3>
          <ol class="muted">
            <li>Cadastrar produtos (só uma vez). Eles ficam salvos no navegador.</li>
            <li>Configurar precificação em <strong>pricing.html</strong>.</li>
            <li>Selecionar produto e registrar ml usado durante o serviço.</li>
            <li>Marcar checklist e gerar PDF no final.</li>
          </ol>
        </section>
      </div>
    </main>

    <footer class="footer">
      Premium Detail + Luxury • Preto & Roxo — Studio Mandú
    </footer>

    <!-- ============================
        JavaScript (mantive suas funções, só corrigi duas coisinhas)
        ============================ -->
    <script>
    /* ---------- Storage keys ---------- */
    const STORAGE_KEY = 'estetica_produtos_v1';
    const STORAGE_USOS = 'estetica_usos_v1';
    const STORAGE_CONF = 'estetica_conf_v1';
    const STORAGE_PRICING = 'estetica_pricing_v1';
    const STORAGE_CHECK = 'estetica_checklist_state_v1';

    /* ---------- State ---------- */
    let produtos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    let usosLocal = JSON.parse(localStorage.getItem(STORAGE_USOS) || '[]');
    let conf = JSON.parse(localStorage.getItem(STORAGE_CONF) || '{}');

    /* checklist items */
    const CHECK_ITEMS = [
      'Conferir se a moto está fria',
      'Fechar/selar partes elétricas sensíveis (USB, módulos, conexões)',
      'Aplicar pré-lavagem/espuma (Hydrox Fast / MultiClean)',
      'Deixar agir e enxaguar',
      'Pneu dianteiro - limpeza',
      'Roda dianteira - faces e palhetas',
      'Cubos/raios',
      'Pinça e pastilhas (limpeza cuidadosa)',
      'Disco de freio (limpeza neutra)',
      'Pneu traseiro - limpeza',
      'Roda traseira - faces e cantos',
      'Coroa e pinhão / proteção',
      'Corrente - desengraxe e lubrificação (Motul C2)',
      'Bloco do motor - limpeza (Canelinha / Cross Mol)',
      'Tampas (magneto/embreagem) e pedaleiras',
      'Escape (coletor, abafador, ponteira)',
      'Mesas superior/inferior e suspensão',
      'Bengalas e protetores',
      'Balança e articulações',
      'Para-lamas e carenagens',
      'Painel de instrumentos (limpar sem agressão)',
      'Bateria e capa',
      'Guidão, manoplas e manetes',
      'Espelhos',
      'Farol e auxiliares',
      'Setas e lanterna',
      'Banco piloto e garupa',
      'Fechaduras e tampas do tanque',
      'Acessórios (proteções, baú, sliders)',
      'Secagem completa e ar comprimido nas frestas',
      'Aplicar verniz de motor / selante de pneus / cera',
      'Verificar marcas d’água e retoques finais',
    ];

    /* ---------- Elements ---------- */
    const produtosList = document.getElementById('produtosList');
    const listaProdutos = document.getElementById('listaProdutos');
    const listaUsosDiv = document.getElementById('listaUsos');
    const totalGastoSpan = document.getElementById('totalGasto');
    const checklistGrid = document.getElementById('checklistGrid');
    const selectService = document.getElementById('selectService');
    const openPricing = document.getElementById('openPricing');

    openPricing.addEventListener('click', ()=> {
      window.location.href = 'pricing.html';
    });

    function init(){
      renderProdutos();
      renderListaProdutosSelect();
      renderUsos();
      renderChecklist();
      loadConfToUI();
      loadPricingToSelect();
    }
    init();

    /* ---------- Checklist (Deluxe) ---------- */
    function renderChecklist(){
      checklistGrid.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem(STORAGE_CHECK) || '[]');
      CHECK_ITEMS.forEach((txt,i)=>{
        const card = document.createElement('div');
        card.className = 'check-card' + (saved[i]? ' checked':'');
        card.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="22" height="22" rx="6" stroke="rgba(255,255,255,0.06)" fill="none"/>
            <path d="M6 12l3 3 9-9" stroke="${saved[i]? '#00FF9C' : 'rgba(255,255,255,0.5)'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <div class="title">${txt}</div>
            <div class="sub">Toque para marcar / desmarcar</div>
          </div>
          <input type="checkbox" data-i="${i}" ${saved[i]? 'checked':''} />
        `;
        card.addEventListener('click', (e)=>{
          const cb = card.querySelector('input[type=checkbox]');
          cb.checked = !cb.checked;
          card.classList.toggle('checked', cb.checked);
          saveChecklistState();
          const path = card.querySelector('path');
          if(path) path.setAttribute('stroke', cb.checked ? '#00FF9C' : 'rgba(255,255,255,0.5)');
        });
        checklistGrid.appendChild(card);
      });
    }

    function saveChecklistState(){
      const arr = Array.from(checklistGrid.querySelectorAll('input[type=checkbox]')).map(cb=>cb.checked);
      localStorage.setItem(STORAGE_CHECK, JSON.stringify(arr));
    }

    function getChecklistState(){
      return Array.from(checklistGrid.querySelectorAll('input[type=checkbox]')).map((cb,i)=>({text:CHECK_ITEMS[i], checked:cb.checked}));
    }

    /* ---------- Produtos CRUD ---------- */
    function saveProdutos(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(produtos)); }
    function saveUsos(){ localStorage.setItem(STORAGE_USOS, JSON.stringify(usosLocal)); }
    function saveConf(){ localStorage.setItem(STORAGE_CONF, JSON.stringify(conf)); }

    function renderProdutos(){
      produtosList.innerHTML = '';
      produtos.forEach((p,idx)=>{
        const div = document.createElement('div');
        div.className = 'produto-card';
        div.innerHTML = `<div class='produto-info'><strong>${p.nome}</strong><div class='muted'>R$ ${p.preco.toFixed(2)} • ${p.quantidade}ml • R$/${(p.preco/p.quantidade).toFixed(3)}</div></div>
          <div style='display:flex;gap:8px;align-items:center'>
            <button class='ghost small' onclick='editProduto(${idx})'>Editar</button>
            <button class='btn-danger small' onclick='removeProduto(${idx})'>Remover</button>
          </div>`;
        produtosList.appendChild(div);
      });
      renderListaProdutosSelect();
    }

    function renderListaProdutosSelect(){
      listaProdutos.innerHTML = '';
      if(produtos.length===0){
        const o = document.createElement('option'); o.value=''; o.textContent='Nenhum produto cadastrado'; listaProdutos.appendChild(o); return;
      }
      produtos.forEach((p,idx)=>{
        const o = document.createElement('option'); o.value=idx; o.textContent=`${p.nome} | R$${p.preco.toFixed(2)} / ${p.quantidade}ml`; listaProdutos.appendChild(o);
      });
    }

    function addProduto(){
      const nome = document.getElementById('produtoNome').value.trim();
      const preco = parseFloat(document.getElementById('produtoPreco').value);
      const ml = parseFloat(document.getElementById('produtoML').value);
      if(!nome || isNaN(preco) || isNaN(ml)){ alert('Preencha todos os campos do produto'); return; }
      // push properly
      produtos.push({nome: nome, preco: preco, quantidade: ml});
      saveProdutos(); renderProdutos();
      document.getElementById('produtoNome').value='';document.getElementById('produtoPreco').value='';document.getElementById('produtoML').value='';
    }

    function editProduto(i){
      const p = produtos[i];
      const novoNome = prompt('Nome do produto', p.nome);
      if(novoNome===null) return;
      const novoPreco = parseFloat(prompt('Preço (R$)', p.preco));
      if(isNaN(novoPreco)) return;
      const novoMl = parseFloat(prompt('Quantidade (ml)', p.quantidade));
      if(isNaN(novoMl)) return;
      produtos[i]={nome:novoNome, preco:novoPreco, quantidade:novoMl}; saveProdutos(); renderProdutos();
    }

    function removeProduto(i){ if(!confirm('Remover produto?')) return; produtos.splice(i,1); saveProdutos(); renderProdutos(); }

    /* ---------- Usos (consumo por serviço) ---------- */
    function renderUsos(){
      listaUsosDiv.innerHTML=''; let total=0;
      usosLocal.forEach((u,idx)=>{
        const div = document.createElement('div');
        div.className='produto-card';
        div.innerHTML = `<div><strong>${u.nome}</strong><div class='muted'>${u.qtd} ml • custo: R$ ${u.gasto.toFixed(2)}</div></div>
          <div style='display:flex;gap:8px;align-items:center'>
            <button class='ghost small' onclick='editarUso(${idx})'>Editar</button>
            <button class='btn-danger small' onclick='removerUso(${idx})'>Remover</button>
          </div>`;
        listaUsosDiv.appendChild(div);
        total += u.gasto;
      });
      totalGastoSpan.textContent = total.toFixed(2);
      saveUsos();
    }

    function addUso(){
      if(produtos.length===0){ alert('Cadastre primeiro produtos'); return; }
      const idx = parseInt(listaProdutos.value);
      if(isNaN(idx) || idx<0){ alert('Selecione um produto válido'); return; }
      const qtd = parseFloat(document.getElementById('qtdUsada').value);
      if(isNaN(qtd) || qtd<=0){ alert('Quantidade inválida'); return; }
      const prod = produtos[idx];
      const custoMl = prod.preco / prod.quantidade;
      const gasto = custoMl * qtd;
      usosLocal.push({nome:prod.nome, qtd, gasto});
      document.getElementById('qtdUsada').value='';
      renderUsos();
    }

    function removerUso(i){ if(!confirm('Remover este uso?')) return; usosLocal.splice(i,1); renderUsos(); }
    function editarUso(i){ const novo = parseFloat(prompt('Nova quantidade (ml)', usosLocal[i].qtd)); if(isNaN(novo)) return; const prod = produtos.find(p=>p.nome===usosLocal[i].nome); const custoMl = prod.preco/prod.quantidade; usosLocal[i].qtd=novo; usosLocal[i].gasto=custoMl*novo; renderUsos(); }
    function clearUsos(){ if(!confirm('Limpar todos os usos?')) return; usosLocal=[]; renderUsos(); }

    /* ---------- Config ---------- */
    function salvarConfig(){ conf.nomeEstetica = document.getElementById('nomeEstetica').value; conf.nomeCliente = document.getElementById('nomeCliente').value; conf.obs = document.getElementById('obs').value; saveConf(); alert('Configuração salva'); }
    function carregarConfig(){ loadConfToUI(); alert('Configuração carregada'); }
    function loadConfToUI(){ document.getElementById('nomeEstetica').value = conf.nomeEstetica||''; document.getElementById('nomeCliente').value = conf.nomeCliente||''; document.getElementById('obs').value = conf.obs||''; }

    /* ---------- Pricing integration ---------- */
    function loadPricingToSelect(){
      const pricingState = JSON.parse(localStorage.getItem(STORAGE_PRICING) || 'null');
      selectService.innerHTML = '';
      const opt0 = document.createElement('option'); opt0.value='-1'; opt0.textContent='Nenhum serviço configurado'; selectService.appendChild(opt0);
      if(pricingState && pricingState.services && pricingState.services.length){
        pricingState.services.forEach((s,idx)=>{
          const opt = document.createElement('option');
          const c = (s.cost || 0);
          opt.value = idx;
          opt.textContent = `${s.name} — R$ ${c.toFixed(2)} (h: ${s.hours})`;
          selectService.appendChild(opt);
        });
        if(typeof pricingState.selected === 'number' && pricingState.selected >= 0){
          selectService.value = pricingState.selected;
        }
      }
    }

    selectService.addEventListener('change', ()=>{
      const pricingState = JSON.parse(localStorage.getItem(STORAGE_PRICING) || 'null');
      if(!pricingState) return;
      pricingState.selected = parseInt(selectService.value);
      localStorage.setItem(STORAGE_PRICING, JSON.stringify(pricingState));
    });

    /* ---------- Export / Import JSON ---------- */
    function exportarJSON(){
      const data = {produtos, usos:usosLocal, conf, checklist: getChecklistState(), pricing: JSON.parse(localStorage.getItem(STORAGE_PRICING) || 'null')};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'estetica_dados.json'; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
    }

    window.importFromFile = function(file){
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const data = JSON.parse(e.target.result);
          if(data.produtos) produtos = data.produtos;
          if(data.usos) usosLocal = data.usos;
          if(data.conf) conf = data.conf;
          if(data.pricing) localStorage.setItem(STORAGE_PRICING, JSON.stringify(data.pricing));
          saveProdutos(); saveUsos(); saveConf(); renderProdutos(); renderUsos(); loadConfToUI(); loadPricingToSelect();
          alert('Importado com sucesso');
        }catch(err){ alert('Erro ao importar: '+err); }
      };
      reader.readAsText(file);
    };

    /* ---------- PDF generation (products + selected service cost + 10% profit) ---------- */
    async function gerarPDF(){
      const pricingState = JSON.parse(localStorage.getItem(STORAGE_PRICING) || 'null');
      const selectedService = (pricingState && typeof pricingState.selected === 'number' && pricingState.services && pricingState.services[pricingState.selected]) ? pricingState.services[pricingState.selected] : null;
      const laborCost = selectedService ? (selectedService.cost || 0) : 0;
      const totalProducts = usosLocal.reduce((s,u)=>s+u.gasto,0);
      const subtotal = totalProducts + laborCost;
      const profit = subtotal * 0.10;
      const final = subtotal + profit;

      const pdfRoot = document.createElement('div'); pdfRoot.style.padding='20px'; pdfRoot.style.background='#fff'; pdfRoot.style.color='#000'; pdfRoot.style.fontFamily='Arial'; pdfRoot.style.width='820px';
      const title = document.createElement('h2'); title.textContent = conf.nomeEstetica || 'Estética de Motos'; pdfRoot.appendChild(title);
      pdfRoot.appendChild(Object.assign(document.createElement('div'),{innerHTML:`<strong>Cliente / Moto:</strong> ${conf.nomeCliente||'-'}`}));
      pdfRoot.appendChild(Object.assign(document.createElement('div'),{innerHTML:`<strong>Observações:</strong> ${conf.obs||'-'}`}));
      pdfRoot.appendChild(document.createElement('hr'));
      const hP = document.createElement('h3'); hP.textContent='Produtos usados'; pdfRoot.appendChild(hP);
      usosLocal.forEach(u=>{ pdfRoot.appendChild(Object.assign(document.createElement('div'),{textContent:`${u.nome} — ${u.qtd} ml — R$ ${u.gasto.toFixed(2)}`})); });
      pdfRoot.appendChild(document.createElement('hr'));
      const hL = document.createElement('h3'); hL.textContent='Mão de obra (serviço selecionado)'; pdfRoot.appendChild(hL);
      pdfRoot.appendChild(Object.assign(document.createElement('div'),{textContent: selectedService ? `${selectedService.name} — R$ ${laborCost.toFixed(2)} (horas: ${selectedService.hours})` : 'Nenhum serviço selecionado'}));
      pdfRoot.appendChild(document.createElement('hr'));
      const hC = document.createElement('h3'); hC.textContent='Checklist'; pdfRoot.appendChild(hC);
      getChecklistState().forEach(c=>{ pdfRoot.appendChild(Object.assign(document.createElement('div'),{textContent: `${c.checked? '✔':'◻'} ${c.text}`})); });
      pdfRoot.appendChild(document.createElement('hr'));
      pdfRoot.appendChild(Object.assign(document.createElement('div'),{textContent:`Produtos: R$ ${totalProducts.toFixed(2)} | Mão de obra: R$ ${laborCost.toFixed(2)}`}));
      pdfRoot.appendChild(Object.assign(document.createElement('div'),{textContent:`Subtotal: R$ ${subtotal.toFixed(2)}`}));
      pdfRoot.appendChild(Object.assign(document.createElement('div'),{textContent:`Lucro (10%): R$ ${profit.toFixed(2)}`}));
      pdfRoot.appendChild(Object.assign(document.createElement('h2'),{textContent:`Valor sugerido ao cliente: R$ ${final.toFixed(2)}`}));

      document.body.appendChild(pdfRoot);
      const canvas = await html2canvas(pdfRoot, {scale:2});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({orientation:'portrait', unit:'px', format:[canvas.width, canvas.height]});
      pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
      pdf.save((conf.nomeEstetica||'relatorio') + '_servico.pdf');
      pdfRoot.remove();
    }

/* --- Carregar produtos automaticamente do produtos.json --- */
async function carregarProdutosPadrao() {
  try {
    if (produtos.length === 0) {
      let url = window.location.origin + window.location.pathname;
      url = url.substring(0, url.lastIndexOf('/') + 1) + 'produtos.json';

      const response = await fetch(url, { cache: 'no-store' }); // força sempre atualizar
      if (!response.ok) throw new Error('Falha ao carregar o arquivo JSON');

      const data = await response.json();
      produtos = data;
      saveProdutos();
      renderProdutos();
      console.log('✅ Produtos carregados automaticamente do produtos.json!');
    } else {
      console.log('Produtos já existem no armazenamento local.');
    }
  } catch (error) {
    console.error('⚠️ Erro ao carregar produtos:', error);
  }
}

window.addEventListener('DOMContentLoaded', carregarProdutosPadrao);


    /*---------------------------------- limpar checklist ---------------------------------------*/
    function limparChecklist(){
      if(!confirm("Desmarcar todo checklist?")) return;
      const checks = checklistGrid.querySelectorAll('input[type=checkbox]');
      checks.forEach(cb=>{
        cb.checked = false;
        const card = cb.closest('.check-card');
        if(card) card.classList.remove('checked');
        const path = card ? card.querySelector('path') : null;
        if(path) path.setAttribute('stroke', 'rgba(255,255,255,0.5)');
      });
      saveChecklistState();
    }
    </script>
  </body>
  </html>
